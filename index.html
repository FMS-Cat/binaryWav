<!DOCTYPE html>

<html>
	<head>
		<meta charset="UTF-8">
		<title>binary</title>
		<style type="text/css">
		</style>
	</head>
	<body>
		1, Select the wav file you want to process<br>
		<input id="input" type="file"> <a href="./saw.wav">This is useful saw wave file !</a><br>
		<br>
		2, Select the depth of wav you select ( generally Int16 )<br>
		<select id="depth">
			<option value="0">Int8</option>
			<option value="1" selected>Int16</option>
			<option value="2">Float32</option>
		</select><br>
		<br>
		3, Input the formula ( example is below )<br>
		<input id="formula" type="text" value="t"><br>
		<br>
		4, Input the length of output file<br>
		<input id="sec" type="text" value="5"> sec<br>
		<br>
		5, Go !! ( if you want to check your formula, press "Test" )<br>
		<input id="go" type="button" value="Go" onclick="go()">
		<input id="test" type="button" value="Test" onclick="test()"><br>
		<div id="processing" style="visibility:hidden;color:#FF0066">Processing</div><br>
		<audio id="player" controls autoplay></audio><br>
		<a id="link">Download</a><br>
		<br>
		+,-,*,**,/,%,&,|,^,>>,<<,<,>,<=,>=,==,!=,min,max,abs,sin,cos,tan,exp,rnd<br>
		<br>
		Init : t<br>
		FWD 2x : t,2,*<br>
		Reverse : t,-1,*<br>
		FM : t,3E3,/,sin,1E3,*,t,+<br>
		Stretch : t,t,12,>>,11,<<,-<br>
		Stop : 1E5,t,-1E-5,*,exp,1E5,*,-<br>
		The 42 Melody : t,13,>>,42,&,t,3,>>,*<br>
		<script>
			function setBin(_v,_o,_c,_a)
			{
				var v=Math.floor(_v);
				for(var c=0;c<_c;c++)
				{
					_a.setUint8(_o+c,v%256);
					v=Math.floor(v/256);
				}
			}

			function interpret(_f,_t)
			{
				f=_f.split(",");
				for(var c=0;c<f.length;c++)
				{
					switch(f[c])
					{
						case "t":f[c]=_t;break;
						case "+":f[c-2]=f[c-2]+f[c-1];f.splice(c-1,2);c-=2;break;
						case "-":f[c-2]=f[c-2]-f[c-1];f.splice(c-1,2);c-=2;break;
						case "*":f[c-2]=f[c-2]*f[c-1];f.splice(c-1,2);c-=2;break;
						case "**":f[c-2]=Math.pow(f[c-2],f[c-1]);f.splice(c-1,2);c-=2;break;
						case "/":f[c-2]=f[c-2]/f[c-1];f.splice(c-1,2);c-=2;break;
						case "%":f[c-2]=Math.abs(f[c-2]%f[c-1]);f.splice(c-1,2);c-=2;break;
						case "&":f[c-2]=Math.floor(f[c-2])&Math.floor(f[c-1]);f.splice(c-1,2);c-=2;break;
						case "|":f[c-2]=Math.floor(f[c-2])|Math.floor(f[c-1]);f.splice(c-1,2);c-=2;break;
						case "^":f[c-2]=Math.floor(f[c-2])^Math.floor(f[c-1]);f.splice(c-1,2);c-=2;break;
						case "<<":f[c-2]=Math.floor(f[c-2])<<Math.floor(f[c-1]);f.splice(c-1,2);c-=2;break;
						case ">>":f[c-2]=Math.floor(f[c-2])>>Math.floor(f[c-1]);f.splice(c-1,2);c-=2;break;
						case "<":f[c-2]=f[c-2]<f[c-1]?1:0;f.splice(c-1,2);c-=2;break;
						case ">":f[c-2]=f[c-2]>f[c-1]?1:0;f.splice(c-1,2);c-=2;break;
						case "<=":f[c-2]=f[c-2]<=f[c-1]?1:0;f.splice(c-1,2);c-=2;break;
						case ">=":f[c-2]=f[c-2]>=f[c-1]?1:0;f.splice(c-1,2);c-=2;break;
						case "==":f[c-2]=f[c-2]==f[c-1]?1:0;f.splice(c-1,2);c-=2;break;
						case "!=":f[c-2]=f[c-2]!=f[c-1]?1:0;f.splice(c-1,2);c-=2;break;
						case "min":f[c-2]=Math.min(f[c-2],f[c-1]);f.splice(c-1,2);c-=2;break;
						case "max":f[c-2]=Math.max(f[c-2],f[c-1]);f.splice(c-1,2);c-=2;break;
						case "abs":f[c-1]=Math.abs(f[c-1]);f.splice(c,1);c--;break;
						case "sin":f[c-1]=Math.sin(f[c-1]);f.splice(c,1);c--;break;
						case "cos":f[c-1]=Math.cos(f[c-1]);f.splice(c,1);c--;break;
						case "tan":f[c-1]=Math.tan(f[c-1]);f.splice(c,1);c--;break;
						case "exp":f[c-1]=Math.exp(f[c-1]);f.splice(c,1);c--;break;
						case "rnd":f[c]=Math.random();break;
						default:f[c]=Number(f[c]);break;
					}
				}
				return f[f.length-1];
			}

			function test()
			{
				alert(interpret(document.getElementById("formula").value,0)+"\n( When t=0 )");
			}

			function go()
			{
				var f=document.getElementById("input").files[0];
				if(!f){alert("OUCH! Select the wav file you want to process");return;}
				var depth=document.getElementById("depth").value;

				document.getElementById("processing").style.visibility="visible";

				var reader=new FileReader();
				reader.onload=function(_i)
				{
					var i=_i.target.result;
					var v=new DataView(i);

					var data=0;
					for(var c=0;;c++)
					{
						if(v.getUint8(c)==100)
						{
							if(v.getUint8(c+1)==97&&v.getUint8(c+2)==116&&v.getUint8(c+3)==97)
							{
								data=c;
								break;
							}
						}
					}

					var size=v.getUint8(data+4)+256*(v.getUint8(data+5)+256*(v.getUint8(data+6)+256*(v.getUint8(data+7))));
					var outSize=44100*2*2*document.getElementById("sec").value;

					var out=new ArrayBuffer(44+outSize);
					var o=new DataView(out);

					o.setUint8(0,0x52);o.setUint8(1,0x49);o.setUint8(2,0x46);o.setUint8(3,0x46); // "RIFF"
					setBin(36+outSize,4,4,o); // total - 8byte
					o.setUint8(8,0x57);o.setUint8(9,0x41);o.setUint8(10,0x56);o.setUint8(11,0x45); // "WAVE"
					o.setUint8(12,0x66);o.setUint8(13,0x6D);o.setUint8(14,0x74);o.setUint8(15,0x20); // "fmt "
					setBin(16,16,4,o); // chunk byte
					setBin(1,20,2,o); // format
					setBin(2,22,2,o); // channel
					setBin(44100,24,4,o); // sampling rate
					setBin(44100*2*2,28,4,o); // byte per sec
					setBin(2*2,32,2,o); // byte per sample * channel
					setBin(16,34,2,o); // bit per sample
					o.setUint8(36,0x64);o.setUint8(37,0x61);o.setUint8(38,0x74);o.setUint8(39,0x61); // "data"
					setBin(outSize,40,4,o); // wave size

					for(var t=0;t<outSize/2;t++)
					{
						var r=Math.floor(interpret(document.getElementById("formula").value,t)),p,s;

						if(depth==0)
						{
							p=(r)%size;
							p=(p+size)%size;
							s=v.getUint8(44+p,true);
							s=(s-128)*256;
						}
						if(depth==1)
						{
							p=(r*2)%size;
							p=(p+size)%size;
							s=v.getInt16(44+p,true);
						}
						if(depth==2)
						{
							p=(r*4)%size;
							p=(p+size)%size;
							s=v.getFloat32(44+p,true);
							s=Math.floor(Math.max(Math.min(s,1),-1)*128*256);
						}
						o.setInt16(44+t*2,s,true);
					}

					var blob=new Blob([o],{"type":"application/x-msdownload"});

					window.URL=window.URL||window.webkitURL;
					document.getElementById("link").href=window.URL.createObjectURL(blob);
					document.getElementById("link").download=(+new Date())+".wav";
					document.getElementById("player").src=window.URL.createObjectURL(blob);

					document.getElementById("processing").style.visibility="hidden";
				}
				reader.readAsArrayBuffer(f);
			}
		</script>
	</body>
</html>